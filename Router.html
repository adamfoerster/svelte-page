{#if page}
  <svelte:component this={page.child} {...page.props} />
{/if}

<script>
  import page from 'page'

  /** Creates a route callback with the specified data */
  const getComponentMiddleware = (path, component, data = {}) => {
    /** Allow { component, data } value */
    if (component.component) {
      ;({ component, data } = component)
    }

    return (ctx, next) => {
      const {
        components,
        params,
        state: { path, ...state },
      } = ctx
      data.params = params

      components.push({
        component,
        data: Object.assign(data, state),
      })

      next()
    }
  }

  const getSveltedHierarchy = Router => ctx => {
    const { components } = ctx
    const props = {}

    /** Data needs to always be an object or else nesting won't work */
    components.reduce((prev, { component, data = {} }) => {
      data.page = null
      prev.page = {
        child: component,
        props: data,
      };

      return prev.page.props;
    }, props);

    if (Router.store) {
      Router.store.fire('router:navigation', ctx)
    }
    Router.set(props)
  }

  export default {
    setup(Router) {
      Router.go = page.show
      Router.back = page.back
      Router.getCurrentPath = () => page.current
    },
    data() {
      return {
        page: null,
        strict: true,
        hashbang: true,
      }
    },
    onstate({ previous, current }) {
      if (!previous) {
        const { routes, strict, hashbang } = current

        /** Set up the component hierarchy */
        page('*', (ctx, next) => {
          ctx.components = []
          next()
        })

        /** Generate page routes */
        Object.keys(routes).forEach(path =>
          page(path, getComponentMiddleware(path, routes[path])),
        )

        /** Translate component array into svelte state */
        page('*', getSveltedHierarchy(this))

        /** Allow trailing slash */
        page.strict(strict)

        /** Start the router */
        page.start({ hashbang })
      }
    },
  }
</script>
