<NestedRoute {page} on:notFound>
  <slot></slot>
</NestedRoute>

<script>
  import Page from 'page'
  import { getRouteMiddleware } from './helpers.js'
  import Router from './Router.js'

  export default {
    // TODO: how to do static things on future v3?
    setup(RouterComponent) {
      for (const key in Router) {
        if (Router.hasOwnProperty(key)) {
          RouterComponent[key] = Router[key]
        }
      }
    },
    components: {
      NestedRoute: './NestedRoute.html',
    },
    data() {
      return {
        page: null,
        strict: true,
        hashbang: true,
        context: null,
      }
    },
    oncreate() {
      const { routes, strict, hashbang } = this.get()

      // TODO: maybe remove in V3
      this.push = this.go = Page.show
      this.back = Page.back

      /** Set up the component hierarchy */
      Page('*', (ctx, next) => {
        ctx.components = []
        next()
      })

      /** Generate page routes */
      Object.keys(routes).forEach(path =>
        Page(path, getRouteMiddleware(path, routes)),
      )

      /** Translate component array into svelte state */
      Page('*', ctx => {
        const { components } = ctx
        const props = {
          page: null,
          context: ctx,
        }

        /** Data needs to always be an object or else nesting won't work */
        components.reduce((prev, { component, data = {} }) => {
          data.page = null
          prev.page = {
            child: component,
            props: data,
          }

          return prev.page.props
        }, props)

        this.set(props)

        Router.fire('change', ctx)
      })

      /** Allow trailing slash */
      Page.strict(strict)

      /** Start the router */
      Page.start({ hashbang })
    },
    ondestroy() {
      Page.stop()
      Page.prevContext = undefined;
      Page.callbacks.length = 0;
      Page.exits.length = 0;
      Router.destroy()
    },
    // TODO: rethink this when v3 is out
    onstate({ previous }) {
      if (!previous) {
        this.root.router = this
      }
    },
  }
</script>
