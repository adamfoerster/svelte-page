<NestedRoute {page} on:notFound>
  <slot></slot>
</NestedRoute>

<script>
  import Page from 'page'
  import { getRouteMiddleware, getSveltedHierarchy } from './helpers.js'

  export default {
    components: {
      NestedRoute: './NestedRoute.html',
    },
    data() {
      return {
        /** Page.js instance */
        pageInstance: null,
        /** Current route page object */
        page: null,
        strict: true,
        hashbang: true,
        /** Current route context */
        context: null,
        /** Current path */
        path: null,
      }
    },
    onstate({ previous }) {
      /** Add the router to the root component before its oncreate method */
      if (!previous) {
        this.root.router = this
      }
    },
    oncreate() {
      const pageInstance = Page.create()
      const { routes, strict, hashbang } = this.get()

      this.push = this.go = pageInstance.show
      this.back = Page.back

      /** Set up the component hierarchy */
      pageInstance('*', (ctx, next) => {
        ctx.components = []
        next()
      })

      /** Generate page routes */
      Object.keys(routes).forEach(path =>
        pageInstance(path, getRouteMiddleware(path, routes)),
      )

      /** Translate component array into svelte state */
      pageInstance('*', getSveltedHierarchy(this))

      /** Allow trailing slash */
      pageInstance.strict(strict)

      /** Start the router */
      pageInstance.start({ hashbang })

      this.set({ pageInstance })
    },
    ondestroy() {
      const { pageInstance } = this.get()
      pageInstance.stop()
      pageInstance.prevContext = null
      pageInstance.callbacks = []
      pageInstance.exits = []
      delete this.root.router
    },
  }
</script>
